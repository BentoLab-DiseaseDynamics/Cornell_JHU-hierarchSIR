name: Submit forecasts

on:
  workflow_call:
    secrets:
      SUBMIT_FORECAST_TOKEN:
        required: true
      PR_CREATION_TOKEN:
        required: true
  workflow_dispatch:

permissions:
  contents: write         # Allows pushing commits
  pull-requests: write    # Allows creating and merging PRs

jobs:

  submit_forecasts:

    runs-on: ubuntu-latest

    steps:
      # Checkout your main forecast repo
      - name: Checkout forecast repository
        uses: actions/checkout@v5
        with:
          repository: BentoLab-DiseaseDynamics/Cornell_JHU-hierarchSIR
          path: forecast-repo

      # Find latest forecast file
      - name: Find latest forecast file
        working-directory: forecast-repo
        run: |
          LATEST_FILE=$(ls data/interim/calibration/forecast/SIR-1S/hyperparameters-exclude_None/*.csv | sort -r | head -n 1)
          ABS_PATH="${GITHUB_WORKSPACE}/forecast-repo/${LATEST_FILE}"
          FILENAME=$(basename "$LATEST_FILE") 
          REFERENCE_DATE=${FILENAME:0:10}
          echo "Found latest forecast file: $ABS_PATH"
          echo "LATEST_FILE=$ABS_PATH" >> $GITHUB_ENV
          echo "REFERENCE_DATE=$REFERENCE_DATE" >> $GITHUB_ENV

      # Checkout your forked challenge repo
      - name: Checkout CDC FluSight repository fork
        uses: actions/checkout@v5
        with:
          repository: BentoLab-DiseaseDynamics/FluSight-forecast-hub
          ref: main
          path: challenge-repo
          persist-credentials: false
    
      # Add upstream remote and sync fork/main
      - name: Sync CDC FluSight repository with upstream (cdcepi)
        shell: bash
        working-directory: challenge-repo
        env:
          SUBMIT_FORECAST_TOKEN: ${{ secrets.SUBMIT_FORECAST_TOKEN }}
        run: |
          git remote add upstream https://github.com/cdcepi/FluSight-forecast-hub.git
          git fetch upstream
          git checkout main
          git merge --ff-only upstream/main || git rebase upstream/main
          git push https://x-access-token:${SUBMIT_FORECAST_TOKEN}@github.com/BentoLab-DiseaseDynamics/FluSight-forecast-hub.git main

      # Copy the file between repositories
      - name: Copy forecast file
        shell: bash
        working-directory: challenge-repo
        run: |
          mkdir -p model-output/Cornell_JHU-hierarchSIR/
          cp "${{ env.LATEST_FILE }}" model-output/Cornell_JHU-hierarchSIR/
      
      # Commit and push the forecast to the fork
      - name: Commit and push forecast to fork
        shell: bash
        working-directory: challenge-repo
        env:
          SUBMIT_FORECAST_TOKEN: ${{ secrets.SUBMIT_FORECAST_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch using reference date
          BRANCH="forecast-${{ env.REFERENCE_DATE }}"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git checkout -B "$BRANCH"
          
          # Stage the new forecast file
          git add model-output/Cornell_JHU-hierarchSIR/$(basename "${{ env.LATEST_FILE }}")
          git commit -m "Add forecast for ${{ env.REFERENCE_DATE }}"

          # Use PAT for authentication when pushing
          git push https://x-access-token:${SUBMIT_FORECAST_TOKEN}@github.com/BentoLab-DiseaseDynamics/FluSight-forecast-hub.git "$BRANCH"

      # Create pull request to upstream challenge repo
      - name: Create pull request to upstream challenge repo
        shell: bash
        working-directory: challenge-repo
        env:
          PR_CREATION_TOKEN: ${{ secrets.PR_CREATION_TOKEN }}
        run: |
          sudo apt install -y gh
          echo "${PR_CREATION_TOKEN}" | gh auth login --with-token
          gh pr create \
            --repo cdcepi/FluSight-forecast-hub \
            --head BentoLab-DiseaseDynamics:${{ env.BRANCH }} \
            --base main \
            --title "Cornell_JHU-hierarchSIR Automated Forecast Submission ${{ env.REFERENCE_DATE }}" \
            --body "This PR contains the Cornell_JHU-hierarchSIR forecast for reference date ${{ env.REFERENCE_DATE }}."
